<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Source: includes/data-port/class-sensei-import-csv-reader.php - Sensei LMS Hook Docs</title>

	<script src="scripts/prettify/prettify.js"> </script>
	<script src="scripts/prettify/lang-css.js"> </script>
	<!--[if lt IE 9]>
	  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
	<link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="styles.css">
</head>

<body>

<div id="main">

	
	<h1 class="page-title">Source: includes/data-port/class-sensei-import-csv-reader.php</h1>
	

	



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * File containing the Sensei_Import_CSV_Reader class.
 *
 * @package sensei
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * This class is responsible for reading a CSV file.
 */
class Sensei_Import_CSV_Reader {
	const MB_ENCODING_DETECTION_ORDER = 'UTF-8, ISO-8859-1, ISO-8859-15, EUC-JP, eucJP-win, JIS, ISO-2022-JP, ASCII';

	/**
	 * The file to be read.
	 *
	 * @var SplFileObject
	 */
	private $file;

	/**
	 * Number of data lines that are already read.
	 *
	 * @var int
	 */
	private $completed_lines;

	/**
	 * Number of the total lines of the file (the first line is not included).
	 *
	 * @var int
	 */
	private $total_lines;

	/**
	 * Whether reading is completed.
	 *
	 * @var bool
	 */
	private $is_completed;

	/**
	 * Number of lines to be read by each read_lines call.
	 *
	 * @var int
	 */
	private $lines_per_batch;

	/**
	 * Sensei_Import_CSV_Reader constructor.
	 *
	 * @param string $csv_file         The CSV file name.
	 * @param int    $completed_lines  Number of data lines to skip.
	 * @param int    $lines_per_batch  Number of lines to be read on each read_lines call.
	 */
	public function __construct( $csv_file, $completed_lines = 0, $lines_per_batch = 30 ) {
		$this->file = new SplFileObject( $csv_file );
		// SplFileObject::READ_AHEAD is absolutely required for iterator_count to work, otherwise it blocks in an
		// internal infinite loop. See: https://bugs.php.net/bug.php?id=63616 - this bug is totally avoided by using
		// SplFileObject::READ_AHEAD.
		$this->file->setFlags( SplFileObject::READ_CSV | SplFileObject::READ_AHEAD );
		$this->detect_delimiter();

		// In PHP 8.0+ SplFileObject::key() doesn't work in the same way as the SplFileObject::key() in PHP 7.x,
		// so we need to use iterator_count instead to count the total number of lines in the file.
		// Also note that, as iterator_count calls SplFileObject::rewind() on $this->file, we need to subtract 1 to
		// ignore the header line and have the same result as SplFileObject::key() in PHP 7.0.
		$this->total_lines = iterator_count( $this->file ) - 1;

		// After computing the total number of lines in the file, we reset the flags to remove the
		// SplFileObject:READ_AHEAD, which breaks our code.
		$this->file->setFlags( SplFileObject::READ_CSV );

		$this->completed_lines = $completed_lines;
		$this->is_completed    = $this->completed_lines >= $this->total_lines;
		$this->lines_per_batch = $lines_per_batch;
	}

	/**
	 * Set the delimiter to read the CSV file.
	 *
	 * The delimiter detection works testing the delimiter which find more columns.
	 */
	private function detect_delimiter() {
		/**
		 * Filters the default CSV delimiter.
		 *
		 * @since 3.2.0
		 * @since 3.3.0 Updated the default to `false`, so it'll get through the delimiter detection.
		 * @hook sensei_import_csv_delimiter
		 *
		 * @param {string} $delimiter The CSV file delimiter.
		 *
		 * @return {false|string} CSV file delimiter or false to skip.
		 */
		$forced_delimiter = apply_filters( 'sensei_import_csv_delimiter', false );

		if ( $forced_delimiter ) {
			$this->file->setCsvControl( $forced_delimiter );
			return;
		}

		/**
		 * Filters the CSV delimiter options.
		 *
		 * @since 3.3.0
		 * @hook sensei_import_csv_delimiter_options
		 *
		 * @param {string[]} $delimiters The CSV file delimiter options.
		 *
		 * @return {array} CSV delimiter options.
		 */
		$delimiters         = apply_filters( 'sensei_import_csv_delimiter_options', [ ',', ';', "\t", '|' ] );
		$max_columns        = 0;
		$selected_delimiter = $delimiters[0];

		foreach ( $delimiters as $delimiter ) {
			$this->file->setCsvControl( $delimiter );

			$columns = $this->get_columns_number();

			if ( false !== $columns &amp;&amp; $columns > $max_columns ) {
				$max_columns        = $columns;
				$selected_delimiter = $delimiter;
			}
		}

		$this->file->setCsvControl( $selected_delimiter );
	}

	/**
	 * Get the number of columns matching the header with the content.
	 *
	 * @return int|false Number of columns or
	 *                   `false` if the number of columns in the header and content doesn't match.
	 */
	private function get_columns_number() {
		$this->file->seek( 0 );
		$first_line_columns = count( $this->file->current() );

		// Skip the header.
		$this->file->next();

		while ( ! $this->file->eof() ) {
			$second_line         = $this->file->current();
			$second_line_columns = count( $second_line );

			// SplFileObject->current() returns [ 0 => null ] on empty lines.
			if ( 1 === $second_line_columns &amp;&amp; empty( $second_line[0] ) ) {
				$this->file->next();
				continue;
			}

			if ( $first_line_columns === $second_line_columns ) {
				return $first_line_columns;
			}

			return false;
		}

		return false;
	}

	/**
	 * Read a batch of lines from the CSV file. It is expected that the file has been validated before this method is
	 * called.
	 *
	 * @return array {
	 *    An array of read lines.
	 *
	 *    @type array {
	 *      An array of the values of a line.
	 *
	 *      @type $$column_name Column value.
	 *    }
	 *    @type WP_Error An error for the specific line.
	 * }
	 */
	public function read_lines() {

		if ( $this->is_completed() ) {
			return [];
		}

		$columns = $this->get_column_names();

		$this->file->seek( $this->completed_lines + 1 );
		$lines_processed = 0;
		$lines           = [];

		$convert_to_utf8 = in_array( get_option( 'blog_charset' ), [ 'utf8', 'utf-8', 'UTF8', 'UTF-8' ], true );

		while ( $lines_processed &lt; $this->lines_per_batch ) {
			$lines_processed++;

			$indexed_line = $this->file->current();

			// SplFileObject->current() returns [ 0 => null ] on empty lines.
			if ( 1 &lt; count( $indexed_line ) || ( 1 === count( $indexed_line ) &amp;&amp; ! empty( $indexed_line[0] ) ) ) {

				if ( count( $indexed_line ) !== count( $columns ) ) {
					$lines[] = new WP_Error(
						'sensei_data_port_job_wrong_number_of_columns',
						__( 'Line has incorrect number of columns.', 'sensei-lms' )
					);
				} else {
					if ( $convert_to_utf8 ) {
						$indexed_line = array_map( [ $this, 'convert_to_utf8' ], $indexed_line );
					}

					$lines[] = array_combine( $columns, $indexed_line );
				}
			} else {
				$lines[] = [];
			}

			if ( $this->file->eof() ) {
				break;
			}

			$this->file->next();
		}

		if ( $this->file->eof() ) {
			$this->is_completed = true;
		}

		$this->completed_lines += $lines_processed;

		return $lines;
	}

	/**
	 * Normalize all strings to UTF-8.
	 *
	 * @param string $value Value to be converted to UTF-8.
	 *
	 * @return string|null
	 */
	private function convert_to_utf8( $value ) {
		if ( null === $value || '' === $value ) {
			return $value;
		}

		$use_mb = function_exists( 'mb_convert_encoding' );

		// Convert to UTF-8.
		if ( $use_mb ) {
			$encoding = mb_detect_encoding( $value, self::MB_ENCODING_DETECTION_ORDER, true );

			if ( $encoding ) {
				$value = mb_convert_encoding( $value, 'UTF-8', $encoding );
			} else {
				$value = mb_convert_encoding( $value, 'UTF-8', 'UTF-8' );
			}
		} else {
			$value = wp_check_invalid_utf8( $value, true );
		}

		return $value;
	}

	/**
	 * Get the column names of the file.
	 *
	 * @return string[]
	 */
	private function get_column_names() {
		$this->file->seek( 0 );

		$column_names = $this->file->current();

		if ( empty( $column_names ) ) {
			return [];
		}

		// Remove BOM if it's present.
		$column_names[0] = str_replace( "\xEF\xBB\xBF", '', $column_names[0] );

		// Make the column names of the CSV file case insensitive.
		return array_map(
			function ( $name ) {
				return strtolower( trim( $name ) );
			},
			$column_names
		);
	}

	/**
	 * Whether the reading of the file is completed.
	 *
	 * @return bool
	 */
	public function is_completed() {
		return $this->is_completed;
	}

	/**
	 * The number of lines that have already been read.
	 *
	 * @return int
	 */
	public function get_completed_lines() {
		return $this->completed_lines;
	}

	/**
	 * The number of total lines in the file (the first line is not included).
	 *
	 * @return int
	 */
	public function get_total_lines() {
		return $this->total_lines;
	}

	/**
	 * Validate a CSV file.
	 *
	 * @param string $file_path        The file path.
	 * @param array  $required_columns The columns that the CSV file is required to have.
	 * @param array  $optional_columns The columns that are optional.
	 *
	 * @return bool|WP_Error
	 */
	public static function validate_csv_file( $file_path, $required_columns, $optional_columns ) {
		if ( ! is_readable( $file_path ) ) {
			return new WP_Error(
				'sensei_data_port_job_unreadable_file',
				__( 'Uploaded file could not be opened.', 'sensei-lms' )
			);
		}

		try {
			$reader = new Sensei_Import_CSV_Reader( $file_path );
		} catch ( Exception $e ) {
			return new WP_Error(
				'sensei_data_port_job_unreadable_file',
				$e->getMessage()
			);
		}

		$columns = $reader->get_column_names();
		if ( empty( $columns ) ) {
			return new WP_Error(
				'sensei_data_port_job_invalid_file',
				__( 'Uploaded file was not a valid CSV.', 'sensei-lms' )
			);
		}

		$has_required_columns     = array_intersect( $required_columns, $columns );
		$missing_required_columns = array_diff( $required_columns, $has_required_columns );

		if ( ! empty( $missing_required_columns ) ) {
			return new WP_Error(
				'sensei_data_port_job_missing_columns',
				sprintf(
					// translators: Placeholder is list of columns that are missing.
					_n(
						'Source file is missing the required column: %s',
						'Source file is missing the required columns: %s',
						count( $missing_required_columns ),
						'sensei-lms'
					),
					implode( ', ', $missing_required_columns )
				)
			);
		}

		$unknown_columns = array_diff( $columns, $required_columns, $optional_columns );

		if ( ! empty( $unknown_columns ) ) {
			return new WP_Error(
				'sensei_data_port_job_unknown_columns',
				sprintf(
					// translators: Placeholder is list of columns that are unknown.
					_n(
						'The following column is unknown: %s',
						'The following columns are unknown: %s',
						count( $unknown_columns ),
						'sensei-lms'
					),
					implode( ', ', $unknown_columns )
				)
			);
		}

		while ( true ) {
			$lines = $reader->read_lines();

			$non_empty_lines = array_filter(
				$lines,
				function( $line ) {
					return ! empty( $line );
				}
			);

			if ( ! empty( $non_empty_lines ) ) {
				break;
			}

			if ( $reader->is_completed() ) {
				return new WP_Error(
					'sensei_data_port_job_empty_file',
					__( 'Uploaded file is empty.', 'sensei-lms' )
				);
			}
		}

		return true;
	}
}
</code></pre>
        </article>
    </section>





	<footer>
		<a href="https://senseilms.com/">SenseiLMS.com</a> &bull;
		<a href="https://github.com/automattic/sensei">Sensei LMS on GitHub</a>
	</footer>


</div>

<nav>
	<h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="sensei_course_learning_mode_load_override_styles.html">sensei_course_learning_mode_load_override_styles</a></li><li><a href="sensei_course_learning_mode_load_theme.html">sensei_course_learning_mode_load_theme</a></li><li><a href="sensei_course_learning_mode_override_theme.html">sensei_course_learning_mode_override_theme</a></li><li><a href="sensei_data_port_complete.html">sensei_data_port_complete</a></li><li><a href="sensei_loaded.html">sensei_loaded</a></li><li><a href="sensei_login_success_redirect_url.html">sensei_login_success_redirect_url</a></li><li><a href="sensei_reports_overview_after_top_filters.html">sensei_reports_overview_after_top_filters</a></li><li><a href="sensei_reports_overview_before_top_filters.html">sensei_reports_overview_before_top_filters</a></li><li><a href="sensei_reports_overview_students_data_provider_pre_user_query.html">sensei_reports_overview_students_data_provider_pre_user_query</a></li><li><a href="sensei_rest_api_category_question_saved.html">sensei_rest_api_category_question_saved</a></li><li><a href="sensei_rest_api_lesson_quiz_update.html">sensei_rest_api_lesson_quiz_update</a></li><li><a href="sensei_rest_api_question_saved.html">sensei_rest_api_question_saved</a></li><li><a href="sensei_tools_listing_after_%257B$tool_id%257D.html">sensei_tools_listing_after_{$tool_id}</a></li></ul><h3>Filters</h3><ul><li><a href="sensei_add_comment_indexes.html">sensei_add_comment_indexes</a></li><li><a href="sensei_admin_notices.html">sensei_admin_notices</a></li><li><a href="sensei_analysis_nav_title.html">sensei_analysis_nav_title</a></li><li><a href="sensei_analysis_sub_menu.html">sensei_analysis_sub_menu</a></li><li><a href="sensei_block_type_args.html">sensei_block_type_args</a></li><li><a href="sensei_can_access_course_content.html">sensei_can_access_course_content</a></li><li><a href="sensei_can_use_users_relationship.html">sensei_can_use_users_relationship</a></li><li><a href="sensei_context_notices.html">sensei_context_notices</a></li><li><a href="sensei_course_block_template.html">sensei_course_block_template</a></li><li><a href="sensei_course_completed_page_template.html">sensei_course_completed_page_template</a></li><li><a href="sensei_course_completed_page_url.html">sensei_course_completed_page_url</a></li><li><a href="sensei_course_learning_mode_enabled.html">sensei_course_learning_mode_enabled</a></li><li><a href="sensei_course_learning_mode_theme_override_enabled.html">sensei_course_learning_mode_theme_override_enabled</a></li><li><a href="sensei_course_loop_content_class.html">sensei_course_loop_content_class</a></li><li><a href="sensei_custom_navigation_allowed_screens.html">sensei_custom_navigation_allowed_screens</a></li><li><a href="sensei_default_feature_flag_settings.html">sensei_default_feature_flag_settings</a></li><li><a href="sensei_duplicate_post_args.html">sensei_duplicate_post_args</a></li><li><a href="sensei_duplicate_post_ignore_meta.html">sensei_duplicate_post_ignore_meta</a></li><li><a href="sensei_existing_questions_query_results.html">sensei_existing_questions_query_results</a></li><li><a href="sensei_file_upload_file_prefix.html">sensei_file_upload_file_prefix</a></li><li><a href="sensei_filter_category_questions_by_author.html">sensei_filter_category_questions_by_author</a></li><li><a href="sensei_get_question_grade.html">sensei_get_question_grade</a></li><li><a href="sensei_get_question_template_data.html">sensei_get_question_template_data</a></li><li><a href="sensei_grading_display_quiz_question.html">sensei_grading_display_quiz_question</a></li><li><a href="sensei_icon_href.html">sensei_icon_href</a></li><li><a href="sensei_import_csv_delimiter.html">sensei_import_csv_delimiter</a></li><li><a href="sensei_import_csv_delimiter_options.html">sensei_import_csv_delimiter_options</a></li><li><a href="sensei_is_login_required.html">sensei_is_login_required</a></li><li><a href="sensei_learner_courses_page_template.html">sensei_learner_courses_page_template</a></li><li><a href="sensei_learner_enrolled_courses_args.html">sensei_learner_enrolled_courses_args</a></li><li><a href="sensei_lesson_archive_title.html">sensei_lesson_archive_title</a></li><li><a href="sensei_lesson_block_template.html">sensei_lesson_block_template</a></li><li><a href="sensei_lesson_content_drip_hide.html">sensei_lesson_content_drip_hide</a></li><li><a href="sensei_lesson_count.html">sensei_lesson_count</a></li><li><a href="sensei_lesson_course_signup_notice_level.html">sensei_lesson_course_signup_notice_level</a></li><li><a href="sensei_lesson_course_signup_notice_message.html">sensei_lesson_course_signup_notice_message</a></li><li><a href="sensei_lesson_excerpt.html">sensei_lesson_excerpt</a></li><li><a href="sensei_lesson_placeholder_image_url.html">sensei_lesson_placeholder_image_url</a></li><li><a href="sensei_lesson_prerequisite.html">sensei_lesson_prerequisite</a></li><li><a href="sensei_lesson_quiz_questions.html">sensei_lesson_quiz_questions</a></li><li><a href="sensei_lesson_show_course_signup_notice.html">sensei_lesson_show_course_signup_notice</a></li><li><a href="sensei_lesson_take_course_url.html">sensei_lesson_take_course_url</a></li><li><a href="sensei_login_url.html">sensei_login_url</a></li><li><a href="sensei_module_course_column_max_links_count.html">sensei_module_course_column_max_links_count</a></li><li><a href="sensei_question_answer_message_correct_answer.html">sensei_question_answer_message_correct_answer</a></li><li><a href="sensei_question_answer_message_css_class.html">sensei_question_answer_message_css_class</a></li><li><a href="sensei_question_answer_message_grade.html">sensei_question_answer_message_grade</a></li><li><a href="sensei_question_answer_message_text.html">sensei_question_answer_message_text</a></li><li><a href="sensei_question_answer_notes.html">sensei_question_answer_notes</a></li><li><a href="sensei_question_image_size.html">sensei_question_image_size</a></li><li><a href="sensei_question_show_answers.html">sensei_question_show_answers</a></li><li><a href="sensei_question_title.html">sensei_question_title</a></li><li><a href="sensei_question_type_specific_properties.html">sensei_question_type_specific_properties</a></li><li><a href="sensei_question_types.html">sensei_question_types</a></li><li><a href="sensei_questions_get_correct_answer.html">sensei_questions_get_correct_answer</a></li><li><a href="sensei_quiz_answer_file_upload_types.html">sensei_quiz_answer_file_upload_types</a></li><li><a href="sensei_quiz_enable_block_based_editor.html">sensei_quiz_enable_block_based_editor</a></li><li><a href="sensei_quiz_ordering_question_type_hide.html">sensei_quiz_ordering_question_type_hide</a></li><li><a href="sensei_quiz_pagination_args.html">sensei_quiz_pagination_args</a></li><li><a href="sensei_quiz_panel_add.html">sensei_quiz_panel_add</a></li><li><a href="sensei_quiz_settings.html">sensei_quiz_settings</a></li><li><a href="sensei_registration_url.html">sensei_registration_url</a></li><li><a href="sensei_reports_overview_export_button_url.html">sensei_reports_overview_export_button_url</a></li><li><a href="sensei_rest_api_lesson_quiz_response.html">sensei_rest_api_lesson_quiz_response</a></li><li><a href="sensei_rest_api_schema_question_type.html">sensei_rest_api_schema_question_type</a></li><li><a href="sensei_rest_api_schema_single_question.html">sensei_rest_api_schema_single_question</a></li><li><a href="sensei_scripts_allowed_pages.html">sensei_scripts_allowed_pages</a></li><li><a href="sensei_scripts_allowed_post_type_pages.html">sensei_scripts_allowed_post_type_pages</a></li><li><a href="sensei_scripts_allowed_post_types.html">sensei_scripts_allowed_post_types</a></li><li><a href="sensei_show_enrolment_debug_button.html">sensei_show_enrolment_debug_button</a></li><li><a href="sensei_show_lesson_numbers.html">sensei_show_lesson_numbers</a></li><li><a href="sensei_student_groups_hide.html">sensei_student_groups_hide</a></li><li><a href="sensei_students_report_last_activity_filter_enabled.html">sensei_students_report_last_activity_filter_enabled</a></li><li><a href="sensei_the_question_number.html">sensei_the_question_number</a></li><li><a href="sensei_tools.html">sensei_tools</a></li><li><a href="sensei_user_courses_filter_options.html">sensei_user_courses_filter_options</a></li><li><a href="sensei_user_courses_query.html">sensei_user_courses_query</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
